# VM系统开发相关文档合集

# readme.md

## 项目简介

本项目是一款支持x86/arm/x64多架构的虚拟机（VM）调度系统，采用「从下到上」的构建思路，核心定位是兼顾内核实时性、VM运行效率与系统安全性，适用于服务器级VM稳定运行、多架构任务协同调度等场景。系统通过静态CPU核隔离、GIL式核锁保护、内核级管理员终端兜底，实现不同架构VM的有序、安全、高效运行。

## 核心架构

系统采用「静态核隔离+动态核池调度+GIL式资源保护+内核安全兜底」的核心架构，CPU核分工固化，避免任务干扰，具体如下：

- 核0（专属）：运行调度器+内核核心任务，处理实时信息、VM生命周期管控，独占核资源，禁止其他任务抢占。

- 核1（专属）：处理外设虚拟、DLL装载、日志持久化等杂务，与VM核池隔离，不影响核心任务与VM运行。

- 核2~N（VM核池）：动态分配给各架构VM运行，采用「每核一把核锁」的GIL式保护，保证单核单VM独占，支持静态独占绑定（供服务器级VM）与动态调度（供普通VM）混合模式。

- 内核信任管理员终端：核0上的2个高优先级内核态轻量级线程，支持应急终结恶意VM、封禁用户、回收核资源，本地物理访问，不可篡改。

## 核心特性

- 多架构兼容：支持x86/arm/x64 VM，封装统一抽象接口，屏蔽架构差异，实现无缝调度。

- 混合调度：支持VM手动申请静态独占核（保证服务器稳定性）与普通VM动态时间片轮转调度（提升资源利用率）。

- 安全兜底：内核级管理员终端，应对恶意VM/用户，支持强制终结、权限封禁，操作日志不可篡改。

- 零拷贝机制：VM直接从payload指针读取指令流，无数据拷贝，多VM共享载荷生效。

- 资源隔离：核级职责隔离、VM资源沙箱隔离，避免跨模块干扰，提升系统健壮性。

## 开发思路

采用「从下到上」的构建法，循序渐进落地，降低开发难度，具体分为5个阶段：

1. 单点突破：实现x86 VM最小可用版本（基础指令集、上下文管理、零拷贝）。

2. 简易闭环：基于x86 VM，实现极简版调度器与核隔离，跑通VM调度全流程。

3. 多架构扩展：实现arm/x64 VM，封装统一抽象接口，整合多架构VM。

4. 上层完善：实现混合调度、静态独占绑定、用户配额管控与饥饿防护。

5. 安全兜底：实现内核管理员终端，完善异常处理与容错机制。

## 当前开发进度

### ✅ 第一阶段完成
- 实现了x86 VM最小可用版本
- 完成基础指令集和上下文管理
- [查看第一阶段开发总结](第一阶段开发总结.md)

### ✅ 第二阶段完成  
- 实现极简版调度器与核隔离
- 跑通VM调度全流程
- [查看第二阶段开发总结](第二阶段开发总结.md)

### ✅ 第三阶段完成
- 实现ARM/x64 VM多架构支持
- 封装统一抽象接口
- 整合多架构VM混合调度
- [查看第三阶段开发总结](第三阶段开发总结.md)

## 依赖工具

- 架构模拟：Unicorn Engine（指令执行）、Capstone Engine（反汇编）、QEMU（参考/二次开发）。

- 系统级开发：libvirt（核管理）、Boost.Thread（跨平台线程）、Linux内核工具链/WDK（内核终端）。

- 调试排错：GDB+GEF、ASAN/Valgrind、spdlog（日志）、WinDbg（Windows内核调试）。

- 工程化：CMake+Ninja（构建）、Git（版本控制）、Clang-Tidy（代码检查）、Doxygen（API文档）。

## 编译和运行

### 直接编译运行（推荐）
```bash
# 编译第三阶段测试程序
g++ -std=c++11 -Wall -Wextra -O2 -I. main.cpp \
    kernel/dispatch/exception_handler.cpp \
    kernel/performance_monitor/performance_monitor.cpp \
    kernel/dispatch/scheduler.cpp -o MyOS_VM.exe -lpthread

# 运行测试
./MyOS_VM.exe
```

### 使用CMake构建
```bash
# 创建构建目录
mkdir build && cd build

# 配置项目
cmake ..

# 编译项目
cmake --build .

# 运行测试
./MyOS_VM.exe
```

## 测试内容

第三阶段测试程序包含以下测试套件：

1. **基本VM操作测试** - 验证VM启动/暂停/恢复/停止功能
2. **多架构统一接口测试** - 验证x86/ARM/x64 VM统一接口兼容性  
3. **调度器集成测试** - 验证多架构VM调度功能
4. **性能监控测试** - 验证性能统计功能
5. **多架构压力测试** - 20个混合架构VM并发执行测试
6. **异常处理测试** - 验证异常处理机制

## 预期开发周期（个人）

- 扎实底层基础（全职）：6-9个月

- 底层基础薄弱（全职）：10-14个月

- 业余开发：1.5-3年

## 注意事项

- 禁止VM绑定核0/核1，避免破坏内核核心任务与杂务处理。

- 底层VM先实现最小可用版本，不追求过度优化，优先跑通流程。

- 管理员终端仅用于应急，禁止日常管理操作，防止滥用。

- 多架构VM开发前，先约定统一抽象接口，避免接口混乱。